---
title: "ACB"
author: "Nguyễn Đức Minh Tân"
date: "2024-04-10"
output: html_document
---

## Tải về và cài đặt các thư viện cần thiết

```{r}
# Install packages
install.packages('tidyverse')
install.packages("quantmod")
install.packages("TTR")
install.packages("PerformanceAnalytics")
install.packages("xts")
install.packages("Metrics")
```

```{r}
# Run library
library(ggplot2)
library(tidyverse)
library(quantmod)
library(xts)
library(TTR)
library(PerformanceAnalytics)
library(tseries)
library(forecast)
library(xts)
```

## Import dữ liệu về cổ phiếu cần phân tích

```{r}
# Xoá toàn bộ data đang lưu trữ trong bộ nhớ
rm(list = ls())
```

```{r}
# Win
# Lấy dữ liệu về cổ phiếu ngân hàng ACB 
ACB <- read.csv('C://Users/Minh Tan/Downloads/ACB_stock.csv')
```

```{r}
# Mac
# Lấy dữ liệu về cổ phiếu ngân hàng ACB 
ACB <- read.csv('/Users/minhtan/Downloads/ACB_stock.csv')
```

## Kiểm tra tập dữ liệu

### Kiểm tra dữ liệu bị thiếu trong tập dữ liệu

```{r}
colSums(is.na(ACB_1))
```

### Giữ lại các cột cần thiết

```{r}
ACB_1 <- subset(ACB, select = c(date, open, high, low, close, nmVolume))
head(ACB_1)
```

## EDA tập dữ liệu

### Kiểm tra tổng quan bộ dữ liệu

```{r}
dim(ACB_1)
```

```{r}
str(ACB_1)
```

```{r}
summary(ACB_1)
summary(ACB_2)
summary(ACB_3)
```

### Kiểm tra dữ liệu trùng lặp

```{r}
# Kiểm tra dữ liệu trùng lặp
n_occur <- data.frame(table(ACB_1$date))
n_occur[n_occur$Freq > 1,]
ACB_1[ACB_1$date %in% n_occur$Var1[n_occur$Freq > 1],]
```

```{r}
# Xoá dữ liệu trùng lặp
ACB_2 <- ACB_1[!duplicated(ACB_1$date), ]
ACB_2
```

### Trực quan hóa dữ liệu các cột bằng biểu đồ

```{r}
# open, close, high, low, nmVolume, nmValue
ggplot(ACB_1, aes(x=open)) + geom_histogram(binwidth = 1) + geom_histogram()
ggplot(ACB_1, aes(x=close)) + geom_histogram(binwidth = 1) + geom_histogram()
ggplot(ACB_1, aes(x=high)) + geom_histogram(binwidth = 1) + geom_histogram()
ggplot(ACB_1, aes(x=low)) + geom_histogram(binwidth = 1) + geom_histogram()
ggplot(ACB_1, aes(x=nmVolume)) + geom_histogram()
```

```{r}
# Tính hệ số tương quan Pearson giữa hai cột open và close
cor(ACB_3$open, ACB_3$close, use = "complete.obs")
ggplot(ACB_3, aes(x=open, y=close)) + geom_point()

# Tính hệ số tương quan Pearson giữa hai cột open và high
cor(ACB_3$open, ACB_3$high, use = "complete.obs")
ggplot(ACB_3, aes(x=open, y=high)) + geom_point()

# Tính hệ số tương quan Pearson giữa hai cột open và low
cor(ACB_3$open, ACB_3$low, use = "complete.obs")
ggplot(ACB_3, aes(x=open, y=low)) + geom_point()

# Tính hệ số tương quan Pearson giữa hai cột high và close
cor(ACB_3$high, ACB_3$close, use = "complete.obs")
ggplot(ACB_3, aes(x=high, y=close)) + geom_point()

# Tính hệ số tương quan Pearson giữa hai cột low và close
cor(ACB_3$low, ACB_3$close, use = "complete.obs")
ggplot(ACB_3, aes(x=low, y=close)) + geom_point()

# Tính hệ số tương quan Pearson giữa hai cột high và low
cor(ACB_3$high, ACB_3$low, use = "complete.obs")
ggplot(ACB_3, aes(x=high, y=low)) + geom_point()
```

### Xác định và loại bỏ các giá trị outlier

```{r}
# Boxplot trước khi xóa outlier

boxplot(ACB_2$open, ACB_2$close, ACB_2$high, ACB_2$low,
        main = "Boxplot of 'open', 'high', 'low', and 'close' Columns",
        names = c("open", "high", "low", "close"),
        ylab = "Price", xlab = "Columns",
        col = c("blue", "red", "green", "orange"))
boxplot(ACB_2$nmVolume, main="Boxplot of 'nmVolume' Column", ylab="Trading volume")
```

```{r}
# Xác định giá trị outlier trong data frame
outlier_values_nmVolume <- boxplot.stats(ACB_2$nmVolume)$out 

# Xác định vị trí các outlier trong data frame.
id_nmVolume<- which(ACB_2$nmVolume %in% outlier_values_nmVolume)

id <- unique(c(id_nmVolume))
id
# Xoá Outlier
ACB_3 <- ACB_2[-id,]
```

```{r}
# Kiểm tra lại bằng Boxplot

boxplot(ACB_3$open, ACB_3$close, ACB_3$high, ACB_3$low,
        main = "Boxplot of 'open', 'high', 'low', and 'close' Columns",
        names = c("open", "high", "low", "close"),
        ylab = "Price", xlab = "Columns",
        col = c("blue", "red", "green", "orange"))
boxplot(ACB_3$nmVolume, main="Boxplot of 'nmVolume' Column", ylab="Trading volume")
```

```{r}
# Kiểm tra lại bằng Histogram

ggplot(ACB_3, aes(x=open)) + geom_histogram(binwidth = 1) + geom_histogram()
ggplot(ACB_3, aes(x=close)) + geom_histogram(binwidth = 1) + geom_histogram()
ggplot(ACB_3, aes(x=high)) + geom_histogram(binwidth = 1) + geom_histogram()
ggplot(ACB_3, aes(x=low)) + geom_histogram(binwidth = 1) + geom_histogram()
ggplot(ACB_3, aes(x=nmVolume)) + geom_histogram()
```

### Chuyển định dạng dữ liệu cột date

```{r}
ACB_3$date <- as.Date(ACB_3$date)
summary(ACB_3)
```

## Vẽ biểu đồ

```{r}
# Giá mở cửa qua từng năm
ggplot(ACB_3, aes(x = date, y = open)) +
  geom_line() +
  ggtitle("Opening Price Over Time") +
  xlab("Date") +
  ylab("Open Price")

# Giá đóng cửa qua từng năm
ggplot(ACB_3, aes(x = date, y = close)) +
  geom_line() +
  ggtitle("Closing Price Over Time") +
  xlab("Date") +
  ylab("Close Price")

# Khối lượng giao dịch qua từng năm
ggplot(ACB_3, aes(x = date, y = nmVolume)) +
  geom_line() +
  ggtitle("Volume Over Time") +
  xlab("Date") +
  ylab("nmVolume")

# Giá giao dịch cao nhất qua từng năm
ggplot(ACB_3, aes(x = date, y = high)) +
  geom_line() +
  ggtitle("High Price Over Time") +
  xlab("Date") +
  ylab("High")

# Giá giao dịch thấp nhất qua từng năm
ggplot(ACB_3, aes(x = date, y = low)) +
  geom_line() +
  ggtitle("Low Price Over Time") +
  xlab("Date") +
  ylab("Low")
```

\##########################################################################################

# **Phương pháp phân tích**

## Technical analysis with Quantmod

### Vẽ biểu đồ

```{r}
# Chuyển đổi cột 'Date' sang kiểu dữ liệu ngày tháng của R
ACB_3$date <- as.Date(ACB_3$date)

# Chuyển đổi dữ liệu sang đối tượng xts, sử dụng cột 'Date' làm chỉ số
ACB_4 <- xts(ACB_3[, -which(names(ACB_3) == "date")], order.by = ACB_3$date)
```

```{r}
chartSeries(ACB_4, type="line", subset="2013::2023", theme=chartTheme("white"))
```

### Các chỉ báo kỹ thuật

#### Bollinger band

```{r}
bb <-BBands(Cl(ACB_3),s.d=2)
tail(bb,n=5)
```

```{r}
chartSeries(ACB_3, type="line", subset="2013::2023", theme=chartTheme("white"))
addBBands(n = 20, sd = 2, maType = SMA)
addSMA(n = 20, on = 1, col = "blue")
```

#### **Momentum**

```{r}
M <- momentum(Cl(ACB_3), n=2)
head (M,n=5)
```

```{r}
chartSeries(ACB_3, type="line", subset="2013::2023", theme=chartTheme("white"))
addMomentum(n = 10)
```

#### Thêm các chỉ số phân tích kỹ thuật vào đồ thị

```{r}
chartSeries(ACB_3, type="line", subset="2013::2023", theme=chartTheme("white"))
addMACD()
addRSI()
```

### Mô hình ARIMA

#### Kiểm định tính dừng

```{r}
# Đồ thị phân phối giá đóng cửa ACB
chartSeries(ACB_4$close, type="line", subset="2013::2023", theme=chartTheme("white"), name="Biểu đồ giá đóng cửa ACB")

# Kiểm định tính dừng
print(adf.test(ACB_4$close))
```

##### Chuyển đổi dữ liệu thành chuỗi có tính dừng

```{r}
# Tạo ra một chuỗi số mới có tính dừng.
stock = diff(log(ACB_4$close), lag = 1)
stock = stock[!is.na(stock)]
plot(stock,main = "log return plot")
```

```{r}
# Kiểm định ADF kiểm tra tính dừng của chuỗi.
print(adf.test(stock))
```

#### Lựa chọn tham số ARIMA (p, d, q)

```{r}
fit <- auto.arima(stock)
summary(fit)
```

```{r}
fit <- auto.arima(stock, trace = TRUE, ic = "aic", allowdrift = TRUE, stepwise = FALSE, approximation = FALSE)
```

#### Tiến hành dự đoán

##### Chia tập dữ liệu thành 2 phần

```{r}
# Tính toán điểm ngắt
breakpoint = floor(nrow(stock) * 0.8)

# Tạo tập huấn luyện
train = stock[1:breakpoint, ]

# Tạo tập kiểm tra
test = stock[(breakpoint + 1):nrow(stock), ]
```

##### Vòng lặp for

```{r}
#Khởi tạo một xts object cho giá trị thực tế của log return
nrow(train)
```

```{r}
a = 2024
stock[a,]
```

```{r}
#Lay gia tri date truoc ngay co stt a
Actual_series = xts(0,as.Date("2021-06-03","%Y-%m-%d"))
Actual_series
```

```{r}
#Khởi tạo dataframe của chuỗi forecast
forecasted_series = data.frame(STT = integer(),Forecasted = numeric (),Upper_Forecasted = numeric(),Lower_Forecasted = numeric())
for(b in a:nrow(stock)-1){
  stock_train = stock[1:b,]
  stock_test = stock[-row(stock_train),]
  
#Summary ARIMA model
fit = arima(stock_train,order = c(0,0,2),include.mean = FALSE)
summary(fit)

#Plotting residual plot
#acf(fit$residuals,main="Residuals plot")
#Forecast log returns
arima.forecast = forecast(fit,h=1,level = 95)
summary(arima.forecast)

#Thêm giá trị dự báo vào chuỗi forecasted_series
forecasted_series = rbind(forecasted_series,c(STT = b+1,Forecasted = arima.forecast$mean[1],arima.forecast$upper,arima.forecast$lower))

#Plotting the forecast
#par(mfrow=c(1,1))
#plot(arima.forecast,main = "ARIMA forecast")
#Tạo ra một chuỗi actual return của giai đoạn dự báo
Actual_return = stock[(b+1),]
Actual_series = c(Actual_series,xts(Actual_return))
rm(Actual_return)
}
```

```{r}
colnames(forecasted_series)=c("STT","Forecasted","Upper_Forecasted","Lower_Forecasted")
print(forecasted_series)
```

#### **Kiểm tra độ chính xác của ARIMA model**

```{r}
#Điều chỉnh độ dài của chuỗi lợi suất
Actual_series = Actual_series[-1]
#Tạo ra object cho chuỗi được dự báo
forecasted_series = xts(forecasted_series,index(Actual_series))
```

```{r}
#So sánh giá trị dự báo và giá trị thực tế
plot(Actual_series,ylim=c(-0.2,0.2),main="Actual return vs Forecasted return")
lines(forecasted_series$Forecasted,lwd=1.5,col = "blue")
lines(forecasted_series$Upper_Forecasted,type = "l",pch = 22,lwd=0.5,col = "red")
lines(forecasted_series$Lower_Forecasted,type = "l",pch = 22,lwd=0.5,col = "red")
legend('bottomright',c('Actual','Forecasted',"Upper forecasted","Lower forecasted"),lty = c(1,1), lwd = c(1.5,1.5),col = c('black','blue','red','red'))
```

```{r}
#Tạo bảng giá trị actual và forecasted
comparision = merge(Actual_series,forecasted_series$Forecasted)
comparision$Accuracy = sign(comparision$Actual_series) == sign(comparision$Forecasted)
print(comparision)
```

```{r}
#tính toán mức độ chính xác
Accuracy_percentage = sum(comparision$Accuracy ==1)*100/length(comparision$Accuracy)
print(Accuracy_percentage)
```

#### RMSE, MAE và MAPE

```{r}
library(Metrics)
cat("RMSE:", rmse(forecasted_series$Forecasted, test), "\n")
cat("MAE:", mae(forecasted_series$Forecasted, test), "\n")
cat("MAPE:", mape(forecasted_series$Forecasted, test), "\n")
```
