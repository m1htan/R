---
title: "QuantStrat"
author: "Nguyễn Đức Minh Tân"
date: "2024-04-02"
output: html_document
---

# 1. Cài đặt các thư viện cần thiết

```{r}
install.packages("devtools")
```

```{r}
install_github("braverock/blotter")
install_github("braverock/quantstrat")
```

# 2. Sử dụng thư viện

```{r}
library(devtools)
library(blotter)
library(quantstrat)
```

# 3. Xác định mã cổ phiếu muốn thu thập dữ liệu và số vốn ban đầu

```{r}
options("getSymbols.warning4.0"=FALSE)
from ="2014-01-01"
to ="2024-01-04"
symbols = c("NKE")
currency("USD")
getSymbols(symbols, from=from, to=to, 
           adjust=TRUE)
stock(symbols, currency="USD", multiplier=1)
initEq=10^6
```

# 4. Khởi tạo tài khoản và danh mục đầu tư

```{r}
rm("account.buyHold",pos=.blotter)
rm("portfolio.buyHold",pos=.blotter)

initPortf("buyHold", symbol=symbols)
initAcct("buyHold", portfolios = "buyHold",
         initEq = initEq)
```

# 5. Xem các chỉ số của tài khoản và danh mục đầu tư

```{r}
# Thông tin chi tiết về danh mục:
getPortfolio("buyHold")

# Thông tin về tài khoản liên quan đến danh mục:
getAccount("buyHold")
```

# 6. Chiến lược mua và giữ

## 6.1 Lấy dữ liệu về giá, thời gian và số lượng cổ phiếu cần mua

```{r}
Nike.Buy.Date <- first(time(NKE))
Nike.Buy.Price <- as.numeric(Ad(NKE[Nike.Buy.Date, ]))
Nike.Sell.Date <- last(time(NKE))
Nike.Sell.Price <- as.numeric(Ad(NKE[Nike.Sell.Date, ]))
Nike.Qty <- trunc(initEq / (2 * Nike.Buy.Price))
```

## 6.2 Thêm giao dịch mua vào hệ thống

```{r}
addTxn(Portfolio = "buyHold", 
       Symbol = "NKE", 
       TxnDate = Nike.Buy.Date, 
       TxnQty = Nike.Qty,
       TxnPrice = Nike.Buy.Price,
       TxnFees = 0)
```

## 6.3 Thêm giao dịch bán vào hệ thống

```{r}
addTxn(Portfolio = "buyHold", 
       Symbol = "NKE", 
       TxnDate = Nike.Sell.Date, 
       TxnQty = -Nike.Qty,
       TxnPrice = Nike.Sell.Price,
       TxnFees = 0)
```

## 6.4 Cập nhật tài khoản dựa trên các giao dịch đã thêm

```{r}
updatePortf(Portfolio = "buyHold")
updateAcct(name = "buyHold")
updateEndEq(Account = "buyHold")
```

## 6.5 Vẽ biểu đồ

```{r}
chart.Posn("buyHold", Symbol = "NKE")
```

## 6.6 Xem xét các số liệu thống kê giao dịch

```{r}
out <- perTradeStats("buyHold", "NKE")
t(out)
```

# **7. Quy tắc lọc mua**

## 7.1 Tạo một Portfolio mới

```{r}
rm("account.filter",pos=.blotter)
rm("portfolio.filter",pos=.blotter)


initPortf("filter", symbol=symbols)
initAcct("filter", portfolios = "filter",
         initEq = initEq)
```

## 7.2 Tạo chỉ báo giao dịch

```{r}
price <- Cl(NKE)         
r <- price/Lag(price) - 1    
delta<-0.03
signal <-c(NA)
for (i in 2: length(price)){
    if (r[i] > delta){
         signal[i]<- 1
    } else if (r[i]< -delta){
         signal[i]<- -1
    } else
         signal[i]<- 0
}
```

## 7.3 Chuyển đổi chỉ báo giao dịch thành tín hiệu giao dịch

```{r}
trade <- Lag(signal)
trade <- na.fill(trade,0)
```

## 7.4 Tạo giao dịch mua và bán

```{r}
for (i in 1:length(price)){
  if (as.numeric(trade[i]) == 1){
    addTxn(Portfolio = "filter",
           Symbol = "NKE", 
           TxnDate = time(price[i]), 
           TxnQty = 1000,
           TxnPrice = price[i],
           TxnFees = 0)    
  }
    if (as.numeric(trade[i]) == -1){
    addTxn(Portfolio = "filter",
           Symbol = "NKE", 
           TxnDate = time(price[i]), 
           TxnQty = -1000,
           TxnPrice = price[i],
           TxnFees = 0)    
  }
}
```

## 7.5 Cập nhật tài khoản **dựa trên các giao dịch đã thêm**

```{r}
updatePortf(Portfolio = "filter")
updateAcct(name = "filter")
updateEndEq(Account = "filter")
```

## 7.6 Vẽ biểu đồ

```{r}
chart.Posn("filter", Symbol = "NKE")
```

## 7.7 Xem xét các số liệu thống kê giao dịch

```{r}
out2 <- perTradeStats("filter", "NKE")
t(out2)
```

# 8. SMA (Simple Moving Average)

## 8.1 Tạo một Portfolio mới

```{r}
currency("USD")
strategy.st <- portfolio.st <- account.st <- "SMA"
rm.strat(strategy.st)


initPortf(portfolio.st, symbols)
initAcct(account.st, portfolios=portfolio.st, 
         initEq = initEq)
initOrders(portfolio.st)
strategy(strategy.st, store=TRUE)
```

## 8.2 Tạo chỉ báo

```{r}
add.indicator(
  strategy.st, name="SMA",
  arguments=list(x=quote(Cl(mktdata)), n=30),
  label="sma30")

add.indicator(
  strategy.st, name="SMA",
  arguments=list(x=quote(Cl(mktdata)), n=200),
  label="sma200")
```

## 8.3 Tín hiệu giao dịch

```{r}
# Buy market if SMA30>SMA200
add.signal(
  strategy.st, 
  name="sigComparison",
  arguments=list(columns=c("sma30","sma200"),
                 relationship="gt"),
  label="buy")

# Sell market if SMA30<SMA200
add.signal(
  strategy.st, 
  name="sigComparison",
  arguments=list(columns=c("sma30","sma200"), 
                 relationship="lt"), 
  label="sell")
```

## 8.4 Quy tắc giao dịch

```{r}
# Buy Rule
add.rule(strategy.st, 
         name='ruleSignal', 
         arguments = list(sigcol="buy", 
                          sigval=TRUE,  
                          orderqty=1000, 
                          ordertype='market', 
                          orderside='long', 
                          pricemethod='market', 
                          replace=FALSE), 
         type='enter', 
         path.dep=TRUE)


# Sell Rule
add.rule(strategy.st, 
         name='ruleSignal', 
         arguments = list(sigcol="sell", 
                          sigval=TRUE,  
                          orderqty='all', 
                          ordertype='market', 
                          orderside='long', 
                          pricemethod='market', 
                          replace=FALSE), 
         type='exit', 
         path.dep=TRUE) 
```

## 8.5 Cập nhật tài khoản **dựa trên các giao dịch đã thêm**

```{r}
updatePortf(portfolio.st)
updateAcct(portfolio.st)
updateEndEq(account.st)
```

## 8.6 Vẽ biểu đồ

```{r}
for(symbol in symbols) {
  chart.Posn(Portfolio=portfolio.st,
             Symbol=symbol,log=TRUE)
}
```

## 8.7 Xem xét các số liệu thống kê giao dịch

```{r}
out3<-try(applyStrategy(strategy.st, 
                       portfolios=portfolio.st))
```

# 9. **Quy tắc SMA với bộ lọc biến động**

## 9.1 Tạo một Portfolio mới

```{r}
strategy.st <- portfolio.st <- account.st <- "SMAv"
rm.strat("SMAv")

initPortf(portfolio.st, symbols=symbols,
          from=from, to=to, currency='USD')
initAcct(account.st, portfolios=portfolio.st, 
         from=from, to=to, currency='USD',
         initEq=initEq)
initOrders(portfolio.st, from=from, to=to)
strategy(strategy.st, store=TRUE)
```

## 9.2 Tạo một chỉ báo

```{r}
RB <- function(x,n){
  x <- x
  sd <- runSD(x, n, sample= FALSE)
  med <- runMedian(sd,n)
  mavg <- SMA(x,n)
  signal <- ifelse(sd < med & x > mavg,1,0)
  colnames(signal) <- "RB"
  reclass(signal,x)
}
```

### 9.2.1 Định nghĩa chỉ báo

```{r}
add.indicator(
  strategy.st, name="SMA",
  arguments=list(x=quote(Cl(mktdata)), n=30),
  label="sma30")

add.indicator(
  strategy.st, name="SMA",
  arguments=list(x=quote(Cl(mktdata)), n=200),
  label="sma200")

add.indicator(
  strategy.st, name="RB",
  arguments=list(x=quote(Cl(mktdata)), n=200),
  label="RB")
```

## 9.3 Tín hiệu giao dịch

```{r}
# Buy market if RB>=1
add.signal(strategy.st, 
           name="sigThreshold", 
           arguments = list(threshold=1, column="RB",
                            relationship="gte",
                            cross=TRUE),
           label="buy")

# Sell market if SMA30<SMA200
add.signal(strategy.st, 
           name="sigComparison",
           arguments=list(columns=c("sma30","sma200"), 
                          relationship="lt"), 
           label="sell")
```

## 9.4 Quy tắc giao dịch

```{r}
# Buy Rule
add.rule(strategy.st, 
         name='ruleSignal', 
         arguments = list(sigcol="buy", 
                          sigval=TRUE,  
                          orderqty=1000, 
                          ordertype='market', 
                          orderside='long', 
                          pricemethod='market', 
                          replace=FALSE), 
         type='enter', 
         path.dep=TRUE)

# Sell Rule
add.rule(strategy.st, 
         name='ruleSignal', 
         arguments = list(sigcol="sell", 
                          sigval=TRUE,  
                          orderqty='all', 
                          ordertype='market', 
                          orderside='long', 
                          pricemethod='market', 
                          replace=FALSE), 
         type='exit', 
         path.dep=TRUE) 
```

## 9.5 Cập nhật tài khoản **dựa trên các giao dịch đã thêm**

```{r}
updatePortf(portfolio.st)
updateAcct(portfolio.st)
updateEndEq(account.st)
```

## 9.6 Xem xét các số liệu thống kê giao dịch

```{r}
out4<-try(applyStrategy(strategy.st,
                       portfolios=portfolio.st))
```

## 9.7 Vẽ biểu đồ

```{r}
chart.Posn(Portfolio=portfolio.st,
           Symbol="NKE",
           log=TRUE)
```
