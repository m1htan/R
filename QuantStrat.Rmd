---
title: "QuantStrat"
author: "Nguyễn Đức Minh Tân"
date: "2024-04-02"
output: html_document
---

# Cài đặt các thư viện cần thiết

```{r}
install.packages("devtools")
```

```{r}
install_github("braverock/blotter")
install_github("braverock/quantstrat")
```

# Sử dụng thư viện

```{r}
library(devtools)
library(blotter)
library(quantstrat)
```

# Xác định mã cổ phiếu muốn thu thập dữ liệu và số vốn ban đầu

```{r}
options("getSymbols.warning4.0"=FALSE)
from ="2014-01-01"
to ="2024-01-04"
symbols = c("NKE")
currency("USD")
getSymbols(symbols, from=from, to=to, 
           adjust=TRUE)
stock(symbols, currency="USD", multiplier=1)
initEq=10^6
```

# Khởi tạo tài khoản và danh mục đầu tư

```{r}
rm("account.buyHold",pos=.blotter)
rm("portfolio.buyHold",pos=.blotter)

initPortf("buyHold", symbol=symbols)
initAcct("buyHold", portfolios = "buyHold",
         initEq = initEq)
```

# Các chỉ số của tài khoản và danh mục đầu tư

```{r}
# Thông tin chi tiết về danh mục:
getPortfolio("buyHold")

# Thông tin về tài khoản liên quan đến danh mục:
getAccount("buyHold")
```

# Chiến lược mua và giữ

## Lấy dữ liệu về giá, thời gian và số lượng cổ phiếu cần mua

```{r}
Nike.Buy.Date <- first(time(NKE))
Nike.Buy.Price <- as.numeric(Ad(NKE[Nike.Buy.Date, ]))
Nike.Sell.Date <- last(time(NKE))
Nike.Sell.Price <- as.numeric(Ad(NKE[Nike.Sell.Date, ]))
Nike.Qty <- trunc(initEq / (2 * Nike.Buy.Price))
```

## Thêm giao dịch mua vào hệ thống

```{r}
addTxn(Portfolio = "buyHold", 
       Symbol = "NKE", 
       TxnDate = Nike.Buy.Date, 
       TxnQty = Nike.Qty,
       TxnPrice = Nike.Buy.Price,
       TxnFees = 0)
```

## Thêm giao dịch bán vào hệ thống

```{r}
addTxn(Portfolio = "buyHold", 
       Symbol = "NKE", 
       TxnDate = Nike.Sell.Date, 
       TxnQty = -Nike.Qty,
       TxnPrice = Nike.Sell.Price,
       TxnFees = 0)
```

## Cập nhật tài khoản dựa trên các giao dịch đã thêm

```{r}
updatePortf(Portfolio = "buyHold")
updateAcct(name = "buyHold")
updateEndEq(Account = "buyHold")
```

## Vẽ biểu đồ

```{r}
chart.Posn("buyHold", Symbol = "NKE")
```

## Xem xét các số liệu thống kê giao dịch

```{r}
out <- perTradeStats("buyHold", "NKE")
t(out)
```

# **Quy tắc lọc mua** 

## Tạo một Portfolio mới

```{r}
rm("account.filter",pos=.blotter)
rm("portfolio.filter",pos=.blotter)


initPortf("filter", symbol=symbols)
initAcct("filter", portfolios = "filter",
         initEq = initEq)
```

## Tạo chỉ báo giao dịch

```{r}
price <- Cl(NKE)         
r <- price/Lag(price) - 1    
delta<-0.03
signal <-c(NA)
for (i in 2: length(price)){
    if (r[i] > delta){
         signal[i]<- 1
    } else if (r[i]< -delta){
         signal[i]<- -1
    } else
         signal[i]<- 0
}
```

## Chuyển đổi chỉ báo giao dịch thành tín hiệu giao dịch

```{r}
trade <- Lag(signal)
trade <- na.fill(trade,0)
```

## Tạo giao dịch mua và bán

```{r}
for (i in 1:length(price)){
  if (as.numeric(trade[i]) == 1){
    addTxn(Portfolio = "filter",
           Symbol = "NKE", 
           TxnDate = time(price[i]), 
           TxnQty = 1000,
           TxnPrice = price[i],
           TxnFees = 0)    
  }
    if (as.numeric(trade[i]) == -1){
    addTxn(Portfolio = "filter",
           Symbol = "NKE", 
           TxnDate = time(price[i]), 
           TxnQty = -1000,
           TxnPrice = price[i],
           TxnFees = 0)    
  }
}
```

## Cập nhật tài khoản **dựa trên các giao dịch đã thêm**

```{r}
updatePortf(Portfolio = "filter")
updateAcct(name = "filter")
updateEndEq(Account = "filter")
```

## Vẽ biểu đồ

```{r}
chart.Posn("filter", Symbol = "NKE")
```

## Xem xét các số liệu thống kê giao dịch

```{r}
out2 <- perTradeStats("filter", "NKE")
t(out2)
```
